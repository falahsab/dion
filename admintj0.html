<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة الإدارة | يمن ستلايت</title>

<style>
:root {
    --primary: #00693B; 
    --secondary: #00A651; 
    --bg: #F5F5F5;
    --card-bg: #FFFFFF;
    --text: #0F172A;
    --accent: #FFD700;
}

body { font-family: "Tajawal", sans-serif; background: var(--bg); margin:0; padding:20px; }

.card { max-width: 1000px; margin:auto; background: var(--card-bg); padding:25px; border-radius:15px; box-shadow:0 4px 12px #0002; }

h2,h3{ margin:12px 0; color: var(--primary); }

input, select, button { width: 100%; padding:12px; margin-top:10px; border:1px solid #d1d5db; border-radius:8px; font-size:1rem; box-sizing:border-box; }

button { background: var(--primary); color:white; border:none; cursor:pointer; transition:0.3s; }
button:hover { background: var(--secondary); }

.logout-btn { background:#EF4444; width:auto; padding:10px 20px; }
.logout-btn:hover { background:#DC2626; }

.table-container { overflow-x:auto; margin-top:20px; }

table { width:100%; border-collapse:collapse; font-size:0.95rem; }

th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:center; }

th { background: var(--secondary); color:white; }
.debit { color:red; font-weight:bold; }
.credit { color:green; font-weight:bold; }

.modal { display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); justify-content:center; align-items:center; }

.modal-content { background:#fff; margin:auto; padding:20px; border-radius:10px; width:90%; max-width:420px; animation:fadeIn 0.25s ease; }
@keyframes fadeIn { from{ opacity:0; transform:scale(.9); } to{ opacity:1; } }

.close { color:#555; font-size:28px; cursor:pointer; float:left; }
.close:hover{ color:#000; }

#clientsModal .modal-body { background:#fff; padding:18px; border-radius:10px; width:90%; max-width:900px; max-height:80vh; overflow:auto; }

.stat-box { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px #0001; text-align:center; flex:1; font-weight:bold; }

.wa-btn { background:#25D366;color:white;border:none;padding:6px 12px;border-radius:6px;display:flex;align-items:center;justify-content:center;gap:4px; }
.wa-btn img { width:16px; height:16px; vertical-align:middle; }

</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="admin"){ alert("يجب تسجيل الدخول كأدمن"); window.location.href="index.html"; }
</script>

<div class="card">

<h2>لوحة الإدارة | يمن ستلايت</h2>
<button class="logout-btn" onclick="logout()">تسجيل الخروج</button>

<div style="display:flex;gap:10px;margin:15px 0;">
    <div class="stat-box" id="stat_clients">جاري التحميل...</div>
    <div class="stat-box" id="stat_total">---</div>
    <div class="stat-box" id="stat_last">---</div>
</div>
<button type="button" onclick="openModal('addClientModal')">إضافة عميل جديد</button>
<h3>إضافة عملية مالية</h3>

<select id="client_select">
    <option value="">اختر العميل</option>
</select>


<input id="amount" type="number" placeholder="المبلغ">
<select id="type">
    <option value="debit">عليه</option>
    <option value="credit">له</option>
</select>
<input type="text" style="display:none" autocomplete="username">
<input type="password" style="display:none" autocomplete="new-password">

<input id="note" name="field987" placeholder="البيان"
       autocomplete="off"
       autofill="off"
       data-lpignore="true"
       autocapitalize="off"
       spellcheck="false">
<button id="addTransBtn" type="button" onclick="addTrans()">إضافة العملية</button>

<p id="msg"></p>
<p id="loading"></p>

<h3>آخر 3 عمليات للعميل</h3>
<p id="total_info"></p>

<button type="button" onclick="showAllTransactions()">عرض كل العمليات</button>
<button type="button" onclick="printTransactions()" style="background:#7a39ff;">طباعة PDF</button>

<div class="table-container">
    <table id="transTable"></table>
</div>

<button onclick="showClientsBalances()" style="background:#0b74de">عرض جميع العملاء وصافي حساباتهم</button>


</div>

<!-- مودال إضافة العميل -->
<div id="addClientModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addClientModal')">&times;</span>
    <h3>إضافة عميل جديد</h3>
    <input id="new_name" placeholder="الاسم">
    <input id="new_mobile" type="number" placeholder="رقم الجوال">
    <input id="new_username" placeholder="اسم المستخدم">
    <input id="new_password" type="password" placeholder="كلمة المرور">
    <button onclick="addClient()">إضافة العميل</button>
    <p id="clientMsg"></p>
  </div>
</div>

<!-- مودال تعديل العملية -->
<div id="transModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('transModal')">&times;</span>
    <h3>تعديل العملية</h3>
    <input id="modal_amount" type="number" placeholder="المبلغ">
    <select id="modal_type">
        <option value="debit">عليه</option>
        <option value="credit">له</option>
    </select>
    <input id="modal_note" placeholder="البيان">
    <div style="display:flex;gap:10px;margin-top:10px;">
        <button onclick="saveTransModal()">حفظ</button>
        <button onclick="deleteTransModal()" style="background:#EF4444">حذف</button>
        <button onclick="closeModal('transModal')" style="background:#888">إلغاء</button>
    </div>
  </div>
</div>

<!-- مودال العملاء -->
<div id="clientsModal" class="modal">
  <div class="modal-body">
      <div style="display:flex;justify-content:space-between">
        <h3>قائمة العملاء وصافي الحساب</h3>
        <button class="close-btn" onclick="closeModal('clientsModal')" style="background:#EF4444;padding:6px 12px">إغلاق</button>
      </div>
      <input id="search_client" placeholder="ابحث بالاسم أو رقم الجوال" oninput="filterClientsTable()" style="margin-top:10px">
      <table id="clientsBalanceTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>العميل</th>
                <th>الجوال</th>
                <th>صافي الحساب</th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="printClientsList()" style="background:#0b74de; color:white; margin-top:10px;">طباعة قائمة العملاء</button>

  </div>
  
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzV7lwgDjZ3kz60kCL0YbLCkQoRm6sMtUkzePtAjZuzmC279z3mtHUEEPpwLc4BTzyd/exec"; // ضع رابط الـ Proxy الجديد هنا
const SECRET = "FALAH2025";       // مفتاح سري
const ALLOWED_ORIGIN = "https://falahsab.github.io"; // رابط موقعك
const waIcon = "https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg";

const qs = id => document.getElementById(id);
let allClients=[], clientTransactions=[], currentClientId="", currentTransId=null;

// مودالات
function openModal(id){ qs(id).style.display="flex"; }
function closeModal(id){ qs(id).style.display="none"; }
window.onclick = e=>{ if(e.target.classList.contains("modal")) e.target.style.display="none"; }

// تسجيل خروج
function logout(){ localStorage.clear(); window.location.href="index.html"; }

// تحميل العملاء
async function loadClients(){
    qs("loading").textContent="جاري تحميل العملاء...";
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"getClients"})});
    const data=await res.json();
    allClients=data;
    const select=qs("client_select"); select.innerHTML=`<option value="">اختر العميل</option>`;
    data.forEach(c=>{
        const op=document.createElement("option");
        op.value=c.client_id; op.textContent=`${c.name} (${c.mobile})`;
        select.appendChild(op);
    });
    qs("loading").textContent="";
    updateStats();
}

// بحث العملاء
function filterClientSelect(){
    const q=qs("client_search").value.toLowerCase();
    Array.from(qs("client_select").options).forEach(op=>{
        if(op.value==="") return;
        op.style.display=op.textContent.toLowerCase().includes(q)?"":"none";
    });
}

// إضافة عميل
async function addClient(){
    const name=qs("new_name").value.trim();
    const mobile=qs("new_mobile").value.trim();
    const username=qs("new_username").value.trim();
    const password=qs("new_password").value.trim();
    const msg=qs("clientMsg");
    if(!name||!mobile||!username||!password){ msg.textContent="يرجى تعبئة كل الحقول"; msg.style.color="red"; return; }
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"addClient",name,mobile,username,password})});
    const data=await res.json();
    if(data.status==="success"){ msg.textContent="تمت الإضافة بنجاح"; msg.style.color="green"; loadClients(); setTimeout(()=>closeModal("addClientModal"),800);}
    else{ msg.textContent="حدث خطأ أثناء الإضافة"; msg.style.color="red"; }
}

// إضافة عملية مالية
async function addTrans(){
    const client_id=qs("client_select").value;
    let amount=Number(qs("amount").value);
    const type=qs("type").value; const note=qs("note").value;
    const msg=qs("msg"); if(!client_id||!amount||!note){ msg.textContent="يرجى تعبئة كل الحقول"; msg.style.color="red"; return;}
    amount=type==="credit"?-Math.abs(amount):Math.abs(amount);
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"addTransaction",client_id,amount,type,note})});
    const data=await res.json();
    if(data.status==="success"){ msg.textContent="تمت الإضافة بنجاح"; msg.style.color="green"; qs("amount").value=""; qs("note").value=""; loadTransactions(); setTimeout(()=>msg.textContent="",2000);}
    else{ msg.textContent="حدث خطأ أثناء الإضافة"; msg.style.color="red";}
}

// تحميل العمليات
async function loadTransactions(){
    currentClientId=qs("client_select").value; if(!currentClientId) return;
    qs("loading").textContent="جاري تحميل العمليات...";
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"getClientData",client_id:currentClientId})});
    const data=await res.json();
    qs("loading").textContent=""; if(data.status!=="success") return;
    clientTransactions=data.list.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const total=data.total;
    const client=allClients.find(c=>c.client_id==currentClientId)||{};
    qs("total_info").textContent= total>=0?`إجمالي الرصيد: عليه ${total} ريال`:`إجمالي الرصيد: له ${Math.abs(total)} ريال`;
    updateStats();
    renderTransactions(clientTransactions.slice(0,3));
}

// عرض كل العمليات
function showAllTransactions(){ renderTransactions(clientTransactions); }

// جدول العمليات
function renderTransactions(transactions){
    const table = qs("transTable");
    table.innerHTML = "";

    // رؤوس الأعمدة الجديدة بدون ID واسم العميل
    const header = ["المبلغ","النوع","البيان","التاريخ","واتساب"];
    const trH = document.createElement("tr");
    header.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trH.appendChild(th);
    });
    table.appendChild(trH);

    const client = allClients.find(c => c.client_id == currentClientId) || {};
    const clientName = client.name || "";
    const clientMobile = client.mobile || "";

    transactions.forEach(t => {
        const row = table.insertRow();
        row.onclick = () => openTransModal(t.trans_id);

        // خلايا الجدول بدون ID واسم العميل
        const cells = [
            Math.abs(t.amount),
            t.type === "debit" ? "عليه" : "له",
            t.note,
            new Date(t.date).toLocaleDateString()
        ];

        cells.forEach((c, i) => {
            const td = row.insertCell();
            td.textContent = c;
            if (i === 0) td.className = t.type === "debit" ? "debit" : "credit"; // تلوين المبلغ
        });

        // زر واتساب
        const waCell = row.insertCell();
        const btn = document.createElement("button");
        btn.className = "wa-btn";
        btn.innerHTML = `<img src="${waIcon}"> واتساب`;
        btn.onclick = e => {
            e.stopPropagation();
            const total = clientTransactions.reduce((s, x) => s + Number(x.amount), 0);
            const msg = `العميل: ${clientName}\nالمبلغ: ${Math.abs(t.amount)} ريال\nالنوع: ${t.type === "debit" ? "عليه" : "له"}\nالبيان: ${t.note}\n-----------------\nصافي الحساب: ${total >= 0 ? "عليه "+total : "له "+Math.abs(total)} ريال`;
            window.open(`https://wa.me/${clientMobile}?text=${encodeURIComponent(msg)}`);
        };
        waCell.appendChild(btn);
    });
}


// تعديل وحذف العملية
function openTransModal(id){ currentTransId=id; const t=clientTransactions.find(x=>x.trans_id==id); if(!t) return; qs("modal_amount").value=Math.abs(t.amount); qs("modal_type").value=t.type; qs("modal_note").value=t.note; openModal("transModal"); }
async function saveTransModal(){ if(!currentTransId) return; let amount=Number(qs("modal_amount").value); const type=qs("modal_type").value; const note=qs("modal_note").value; amount=type==="credit"?-Math.abs(amount):Math.abs(amount);
    await fetch(API,{method:"POST",body:JSON.stringify({action:"updateTransaction",trans_id:currentTransId,amount,type,note})}); closeModal("transModal"); loadTransactions(); }
async function deleteTransModal(){ if(!confirm("هل تريد حذف العملية؟")) return; await fetch(API,{method:"POST",body:JSON.stringify({action:"deleteTransaction",trans_id:currentTransId})}); closeModal("transModal"); loadTransactions(); }

// طباعة PDF مع اسم العميل وصافي الحساب
function printTransactions() {
    if (!clientTransactions.length) return alert("لا توجد عمليات للطباعة");

    const client = allClients.find(c => c.client_id == currentClientId) || {};
    const clientName = client.name || "";
    const total = clientTransactions.reduce((s, x) => s + Number(x.amount), 0);

    // بيانات الشركة
    const companyName = "شركة يمن ستلايت";
    const companyPhone = "123456789"; // ضع رقم الهاتف أو البريد إذا أردت
    const logoUrl = "https://raw.githubusercontent.com/falahsab/daftar/refs/heads/main/img/%D8%AF%D9%81%D8%AA%D8%B1-%D9%8A%D9%85%D9%86-%D8%B3%D8%AA%D9%84%D8%A7%D9%8A%D8%AA-192.png"; // ضع رابط شعار الشركة إذا أردت

    const html = `
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>YemenSAT</title>
        <style>
            body { font-family: "Tajawal", sans-serif; direction: rtl; margin:20px; color:#0F172A; }
            header { display:flex; justify-content: space-between; align-items:center; border-bottom: 2px solid #00693B; padding-bottom:10px; margin-bottom:20px; }
            header img { height:60px; }
            header .client-info { text-align: center; flex:1; }
            header .client-info h2 { margin:0; color:#00693B; font-size:1.3em; }
            header .client-info p { margin:0; font-size:0.95em; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #444; padding: 10px; text-align: center; }
            th { background: #00A651; color: white; }
            tbody tr:nth-child(even) { background-color: #f2f2f2; }
            .debit { color: red; font-weight: bold; }
            .credit { color: green; font-weight: bold; }
            tfoot td { font-weight: bold; font-size: 1.05em; }
            footer { margin-top: 40px; text-align: left; font-weight: bold; font-size:0.9em; }
            @media print {
                body { margin: 0; }
                table { page-break-inside: auto; }
                tr { page-break-inside: avoid; page-break-after: auto; }
                thead { display: table-header-group; }
                tfoot { display: table-footer-group; }
                footer { position: fixed; bottom: 0; left: 20px; }
            }
        </style>
    </head>
    <body>
        <header>
            ${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : '<div style="width:60px;"></div>'}
            <div class="client-info">
                <h2>تقرير عمليات العميل</h2>
                <p>اسم العميل: ${clientName}</p>
            </div>
            <div style="width:60px;"></div>
        </header>

        <table>
            <thead>
                <tr>
                    <th>المبلغ</th>
                    <th>النوع</th>
                    <th>البيان</th>
                    <th>التاريخ</th>
                </tr>
            </thead>
            <tbody>
                ${clientTransactions.map(t => {
                    const date = new Date(t.date);
                    const formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
                    return `
                        <tr>
                            <td class="${t.type === "debit" ? "debit" : "credit"}">${Math.abs(t.amount)}</td>
                            <td>${t.type === "debit" ? "عليه" : "له"}</td>
                            <td>${t.note}</td>
                            <td>${formattedDate}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" style="text-align: right;">صافي الحساب</td>
                    <td style="color:${total >= 0 ? 'red' : 'green'};">
                        ${total >= 0 ? `عليه ${total}` : `له ${Math.abs(total)}`}
                    </td>
                </tr>
            </tfoot>
        </table>

        <footer>${companyName} | ${companyPhone}</footer>
    </body>
    </html>
    `;

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
    win.focus();
    setTimeout(() => win.print(), 500);
}


// عرض العملاء وصافي الحساب
async function showClientsBalances(){
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"getClientsBalance"})});
    const data=await res.json(); if(!Array.isArray(data)) return alert("خطأ في البيانات");
    data.sort((a,b)=>b.total-a.total);
    const tbody=document.querySelector("#clientsBalanceTable tbody"); tbody.innerHTML="";
    data.forEach(c=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${c.client_id}</td><td>${c.name}</td><td>${c.mobile}</td>
        <td style="font-weight:bold;color:${c.total>=0?'red':'green'}">${c.total>=0?`عليه ${c.total}`:`له ${Math.abs(c.total)}`}</td>`;
        tbody.appendChild(tr);
    });
    openModal("clientsModal");
}
function filterClientsTable(){
    const q=qs("search_client").value.toLowerCase();
    document.querySelectorAll("#clientsBalanceTable tbody tr").forEach(r=>{
        const name=r.children[1].textContent.toLowerCase();
        const mobile=r.children[2].textContent.toLowerCase();
        r.style.display=(name.includes(q)||mobile.includes(q))?"":"none";
    });
}

// تحديث الإحصائيات
function updateStats(){
    qs("stat_clients").textContent=`عدد العملاء: ${allClients.length}`;
    if(clientTransactions.length){ qs("stat_last").textContent="آخر عملية: "+new Date(clientTransactions[0].date).toLocaleDateString(); }
    else{ qs("stat_last").textContent="لا عمليات"; }
    const sum=clientTransactions.reduce((s,x)=>s+Number(x.amount),0);
    qs("stat_total").textContent=sum>=0?`صافي الحساب: عليه ${sum}`:`صافي الحساب: له ${Math.abs(sum)}`;
}

loadClients();
qs("client_select").addEventListener("change", loadTransactions);

  // طباعة قائمة العملاء وصافي حساباتهم
function printClientsList() {
    const rows = Array.from(document.querySelectorAll("#clientsBalanceTable tbody tr"))
                      .filter(r => r.style.display !== "none"); // تجاهل الصفوف المخفية

    if (!rows.length) return alert("لا توجد بيانات للطباعة");

    const companyName = "شركة يمن ستلايت";
    const companyPhone = "123456789";
    const logoUrl = ""; // شعار الشركة

    const html = `
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <style>
            body { font-family: "Tajawal", sans-serif; direction: rtl; margin:20px; color:#0F172A; }
            header { display:flex; justify-content: space-between; align-items:center; border-bottom: 2px solid #00693B; padding-bottom:10px; margin-bottom:20px; }
            header img { height:60px; }
            header .report-info { text-align: center; flex:1; }
            header .report-info h2 { margin:0; color:#00693B; font-size:1.3em; }
            header .report-info p { margin:0; font-size:0.95em; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #444; padding: 10px; text-align: center; }
            th { background: #00A651; color: white; }
            tbody tr:nth-child(even) { background-color: #f2f2f2; }
            tfoot td { font-weight: bold; font-size: 1.05em; }
            footer { margin-top: 40px; text-align: left; font-weight: bold; font-size:0.9em; }
            @media print {
                body { margin: 0; }
                table { page-break-inside: auto; }
                tr { page-break-inside: avoid; page-break-after: auto; }
                thead { display: table-header-group; }
                tfoot { display: table-footer-group; }
                footer { position: fixed; bottom: 0; left: 20px; }
            }
        </style>
    </head>
    <body>
        <header>
            ${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : '<div style="width:60px;"></div>'}
            <div class="report-info">
                <h2>قائمة العملاء وصافي الحساب</h2>
                <p>عدد العملاء: ${rows.length}</p>
            </div>
            <div style="width:60px;"></div>
        </header>

        <table>
            <thead>
                <tr>
                    <th>العميل</th>
                    <th>الجوال</th>
                    <th>صافي الحساب</th>
                </tr>
            </thead>
            <tbody>
                ${rows.map(r => {
                    const name = r.children[1].textContent;
                    const mobile = r.children[2].textContent;
                    const totalText = r.children[3].textContent.trim(); // مثال: "عليه 500" أو "له 200"
                    
                    // تحديد اللون
                    const color = totalText.startsWith("عليه") ? "red" : "green";

                    return `<tr>
                                <td>${name}</td>
                                <td>${mobile}</td>
                                <td style="color:${color}; font-weight:bold;">${totalText}</td>
                            </tr>`;
                }).join('')}
            </tbody>
        </table>

        <footer>${companyName} | ${companyPhone}</footer>
    </body>
    </html>
    `;

    const win = window.open("", "_blank");
    win.document.title = " "; // لتجنب about:blank
    win.document.write(html);
    win.document.close();
    win.focus();
    setTimeout(() => win.print(), 500);
}


</script>

</body>
</html>
