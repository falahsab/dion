<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة الإدارة | يمن ستلايت</title>

<style>
:root {
    --primary: #00693B; 
    --secondary: #00A651; 
    --bg: #F5F5F5;
    --card-bg: #FFFFFF;
    --text: #0F172A;
    --accent: #FFD700;
}

body { font-family: "Tajawal", sans-serif; background: var(--bg); margin:0; padding:20px; }

.card { max-width: 1000px; margin:auto; background: var(--card-bg); padding:25px; border-radius:15px; box-shadow:0 4px 12px #0002; }

h2,h3{ margin:12px 0; color: var(--primary); }

input, select, button { width: 100%; padding:12px; margin-top:10px; border:1px solid #d1d5db; border-radius:8px; font-size:1rem; box-sizing:border-box; }

button { background: var(--primary); color:white; border:none; cursor:pointer; transition:0.3s; }
button:hover { background: var(--secondary); }

.logout-btn { background:#EF4444; width:auto; padding:10px 20px; }
.logout-btn:hover { background:#DC2626; }

.table-container { overflow-x:auto; margin-top:20px; }

table { width:100%; border-collapse:collapse; font-size:0.95rem; }

th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:center; }

th { background: var(--secondary); color:white; }
.debit { color:red; font-weight:bold; }
.credit { color:green; font-weight:bold; }

.modal { display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); justify-content:center; align-items:center; }

.modal-content { background:#fff; margin:auto; padding:20px; border-radius:10px; width:90%; max-width:420px; animation:fadeIn 0.25s ease; }
@keyframes fadeIn { from{ opacity:0; transform:scale(.9); } to{ opacity:1; } }

.close { color:#555; font-size:28px; cursor:pointer; float:left; }
.close:hover{ color:#000; }

#clientsModal .modal-body { background:#fff; padding:18px; border-radius:10px; width:90%; max-width:900px; max-height:80vh; overflow:auto; }

.stat-box { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px #0001; text-align:center; flex:1; font-weight:bold; }

.wa-btn { background:#25D366;color:white;border:none;padding:6px 12px;border-radius:6px;display:flex;align-items:center;justify-content:center;gap:4px; }
.wa-btn img { width:16px; height:16px; vertical-align:middle; }

</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="admin"){ alert("يجب تسجيل الدخول كأدمن"); window.location.href="index.html"; }
</script>

<div class="card">

<h2>لوحة الإدارة | يمن ستلايت</h2>
<button class="logout-btn" onclick="logout()">تسجيل الخروج</button>

<div style="display:flex;gap:10px;margin:15px 0;">
    <div class="stat-box" id="stat_clients">جاري التحميل...</div>
    <div class="stat-box" id="stat_total">---</div>
    <div class="stat-box" id="stat_last">---</div>
</div>
<button type="button" onclick="openModal('addClientModal')">إضافة عميل جديد</button>
<h3>إضافة عملية مالية</h3>

<select id="client_select">
    <option value="">اختر العميل</option>
</select>

<input id="amount" type="number" placeholder="المبلغ">
<select id="type">
    <option value="debit">عليه</option>
    <option value="credit">له</option>
</select>
<input type="text" style="display:none" autocomplete="username">
<input type="password" style="display:none" autocomplete="new-password">

<input id="note" name="field987" placeholder="البيان"
       autocomplete="off"
       autofill="off"
       data-lpignore="true"
       autocapitalize="off"
       spellcheck="false">
<button id="addTransBtn" type="button" onclick="addTrans()">إضافة العملية</button>

<p id="msg"></p>
<p id="loading"></p>

<h3>آخر 3 عمليات للعميل</h3>
<p id="total_info"></p>

<button type="button" onclick="showAllTransactions()">عرض كل العمليات</button>
<button type="button" onclick="printTransactions()" style="background:#7a39ff;">طباعة PDF</button>

<div class="table-container">
    <table id="transTable"></table>
</div>

<button onclick="showClientsBalances()" style="background:#0b74de">عرض جميع العملاء وصافي حساباتهم</button>

</div>

<!-- مودال إضافة العميل -->
<div id="addClientModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addClientModal')">&times;</span>
    <h3>إضافة عميل جديد</h3>
    <input id="new_name" placeholder="الاسم">
    <input id="new_mobile" type="number" placeholder="رقم الجوال">
    <input id="new_username" placeholder="اسم المستخدم">
    <input id="new_password" type="password" placeholder="كلمة المرور">
    <button onclick="addClient()">إضافة العميل</button>
    <p id="clientMsg"></p>
  </div>
</div>

<!-- مودال تعديل العملية -->
<div id="transModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('transModal')">&times;</span>
    <h3>تعديل العملية</h3>
    <input id="modal_amount" type="number" placeholder="المبلغ">
    <select id="modal_type">
        <option value="debit">عليه</option>
        <option value="credit">له</option>
    </select>
    <input id="modal_note" placeholder="البيان">
    <div style="display:flex;gap:10px;margin-top:10px;">
        <button onclick="saveTransModal()">حفظ</button>
        <button onclick="deleteTransModal()" style="background:#EF4444">حذف</button>
        <button onclick="closeModal('transModal')" style="background:#888">إلغاء</button>
    </div>
  </div>
</div>

<!-- مودال العملاء -->
<div id="clientsModal" class="modal">
  <div class="modal-body">
      <div style="display:flex;justify-content:space-between">
        <h3>قائمة العملاء وصافي الحساب</h3>
        <button class="close-btn" onclick="closeModal('clientsModal')" style="background:#EF4444;padding:6px 12px">إغلاق</button>
      </div>
      <input id="search_client" placeholder="ابحث بالاسم أو رقم الجوال" oninput="filterClientsTable()" style="margin-top:10px">
      <table id="clientsBalanceTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>العميل</th>
                <th>الجوال</th>
                <th>صافي الحساب</th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="printClientsList()" style="background:#0b74de; color:white; margin-top:10px;">طباعة قائمة العملاء</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzV7lwgDjZ3kz60kCL0YbLCkQoRm6sMtUkzePtAjZuzmC279z3mtHUEEPpwLc4BTzyd/exec";
const SECRET = "FALAH2025";       
const ALLOWED_ORIGIN = "https://falahsab.github.io"; 
const waIcon = "https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg";

const qs = id => document.getElementById(id);
let allClients=[], clientTransactions=[], currentClientId="", currentTransId=null;

// توليد token لكل طلب
function generateToken(){ return btoa(Date.now().toString()).slice(-8); }

// مودالات
function openModal(id){ qs(id).style.display="flex"; }
function closeModal(id){ qs(id).style.display="none"; }
window.onclick = e=>{ if(e.target.classList.contains("modal")) e.target.style.display="none"; }

// تسجيل خروج
function logout(){ localStorage.clear(); window.location.href="index.html"; }

// fetch محمي
async function secureFetch(body){
    body.secret = SECRET;
    body.origin = window.location.origin;
    body.token = generateToken();
    const res = await fetch(API,{method:"POST",body:JSON.stringify(body)});
    return await res.json();
}

// تحميل العملاء
async function loadClients(){
    qs("loading").textContent="جاري تحميل العملاء...";
    const data = await secureFetch({action:"getClients"});
    allClients=data;
    const select=qs("client_select"); select.innerHTML=`<option value="">اختر العميل</option>`;
    data.forEach(c=>{
        const op=document.createElement("option");
        op.value=c.client_id; op.textContent=`${c.name} (${c.mobile})`;
        select.appendChild(op);
    });
    qs("loading").textContent="";
    updateStats();
}

// إضافة عميل
async function addClient(){
    const name=qs("new_name").value.trim();
    const mobile=qs("new_mobile").value.trim();
    const username=qs("new_username").value.trim();
    const password=qs("new_password").value.trim();
    const msg=qs("clientMsg");
    if(!name||!mobile||!username||!password){ msg.textContent="يرجى تعبئة كل الحقول"; msg.style.color="red"; return; }
    const data=await secureFetch({action:"addClient",name,mobile,username,password});
    if(data.status==="success"){ msg.textContent="تمت الإضافة بنجاح"; msg.style.color="green"; loadClients(); setTimeout(()=>closeModal("addClientModal"),800);}
    else{ msg.textContent="حدث خطأ أثناء الإضافة"; msg.style.color="red"; }
}

// إضافة عملية مالية
async function addTrans(){
    const client_id=qs("client_select").value;
    let amount=Number(qs("amount").value);
    const type=qs("type").value; const note=qs("note").value;
    const msg=qs("msg"); if(!client_id||!amount||!note){ msg.textContent="يرجى تعبئة كل الحقول"; msg.style.color="red"; return;}
    amount=type==="credit"?-Math.abs(amount):Math.abs(amount);
    const data=await secureFetch({action:"addTransaction",client_id,amount,type,note});
    if(data.status==="success"){ msg.textContent="تمت الإضافة بنجاح"; msg.style.color="green"; qs("amount").value=""; qs("note").value=""; loadTransactions(); setTimeout(()=>msg.textContent="",2000);}
    else{ msg.textContent="حدث خطأ أثناء الإضافة"; msg.style.color="red";}
}

// باقي الوظائف الحالية تبقى كما هي، فقط استبدل كل fetch بـ secureFetch
// ... loadTransactions, renderTransactions, saveTransModal, deleteTransModal, showClientsBalances, printTransactions, printClientsList
// ... كل الدوال السابقة تعمل بنفس الطريقة بدون أي تغيير وظيفي

loadClients();
qs("client_select").addEventListener("change", loadTransactions);
</script>

</body>
</html>
