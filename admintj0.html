
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | ÙŠÙ…Ù† Ø³ØªÙ„Ø§ÙŠØª</title>

<style>
:root {
    --primary: #00693B; 
    --secondary: #00A651; 
    --bg: #F5F5F5;
    --card-bg: #FFFFFF;
    --text: #0F172A;
    --accent: #FFD700;
}

body { font-family: "Tajawal", sans-serif; background: var(--bg); margin:0; padding:20px; }

.card { max-width: 1000px; margin:auto; background: var(--card-bg); padding:25px; border-radius:15px; box-shadow:0 4px 12px #0002; }

h2,h3{ margin:12px 0; color: var(--primary); }

input, select, button { width: 100%; padding:12px; margin-top:10px; border:1px solid #d1d5db; border-radius:8px; font-size:1rem; box-sizing:border-box; }

button { background: var(--primary); color:white; border:none; cursor:pointer; transition:0.3s; }
button:hover { background: var(--secondary); }

.logout-btn { background:#EF4444; width:auto; padding:10px 20px; }
.logout-btn:hover { background:#DC2626; }

.table-container { overflow-x:auto; margin-top:20px; }

table { width:100%; border-collapse:collapse; font-size:0.95rem; }

th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:center; }

th { background: var(--secondary); color:white; }
.debit { color:red; font-weight:bold; }
.credit { color:green; font-weight:bold; }

.modal { display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); justify-content:center; align-items:center; }

.modal-content { background:#fff; margin:auto; padding:20px; border-radius:10px; width:90%; max-width:420px; animation:fadeIn 0.25s ease; }
@keyframes fadeIn { from{ opacity:0; transform:scale(.9); } to{ opacity:1; } }

.close { color:#555; font-size:28px; cursor:pointer; float:left; }
.close:hover{ color:#000; }

#clientsModal .modal-body { background:#fff; padding:18px; border-radius:10px; width:90%; max-width:900px; max-height:80vh; overflow:auto; }

.stat-box { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px #0001; text-align:center; flex:1; font-weight:bold; }

.wa-btn { background:#25D366;color:white;border:none;padding:6px 12px;border-radius:6px;display:flex;align-items:center;justify-content:center;gap:4px; }
.wa-btn img { width:16px; height:16px; vertical-align:middle; }

.input-group {
    display: flex;
    align-items: center;
    gap: 6px;
}

.input-group input {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
}

.pick-btn {
width:50px;
    border: none;
    background: #28a745;
    color: white;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
}
.wa-sms-group {
    display: flex;
    gap: 6px;       /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    justify-content: center;
}

.wa-sms-group button {
    flex: 1;         /* ÙŠØ³Ø§ÙˆÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© */
    padding: 6px 8px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: 0.2s;
}

.wa-sms-group .wa-btn {
    background: #25D366;
}

.wa-sms-group .wa-btn:hover {
    background: #1ebe57;
}

.wa-sms-group .sms-btn {
    background: #3b82f6;
}

.wa-sms-group .sms-btn:hover {
    background: #2563eb;
}


</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="admin"){ alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù†"); window.location.href="index.html"; }
</script>

<div class="card">

<h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | ÙŠÙ…Ù† Ø³ØªÙ„Ø§ÙŠØª</h2>
<button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<div style="display:flex;gap:10px;margin:15px 0;">
    <div class="stat-box" id="stat_clients">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div class="stat-box" id="stat_total">---</div>
    <div class="stat-box" id="stat_last">---</div>
</div>
<button type="button" onclick="openModal('addClientModal')">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
<h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ©</h3>

<select id="client_select">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
</select>


<input id="amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
<select id="type">
    <option value="debit">Ø¹Ù„ÙŠÙ‡</option>
    <option value="credit">Ù„Ù‡</option>
</select>
<input type="text" style="display:none" autocomplete="username">
<input type="password" style="display:none" autocomplete="new-password">

<input id="note" name="field987" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù†"
       autocomplete="off"
       autofill="off"
       data-lpignore="true"
       autocapitalize="off"
       spellcheck="false">
<button id="addTransBtn" type="button" onclick="addTrans()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>

<p id="msg"></p>
<p id="loading"></p>

<h3>Ø¢Ø®Ø± 3 Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„</h3>
<p id="total_info"></p>

<button type="button" onclick="showAllTransactions()">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
<button type="button" onclick="printTransactions()" style="background:#7a39ff;">Ø·Ø¨Ø§Ø¹Ø© PDF</button>

<div class="table-container">
    <table id="transTable"></table>
</div>

<button onclick="showClientsBalances()" style="background:#0b74de">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØµØ§ÙÙŠ Ø­Ø³Ø§Ø¨Ø§ØªÙ‡Ù…</button>


</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div id="addClientModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addClientModal')">&times;</span>
    <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
    <input id="new_name" placeholder="Ø§Ù„Ø§Ø³Ù…">
 <div class="input-group">
    <input id="new_mobile" type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">

    <button class="pick-btn" id="pickContact">ğŸ“±</button>
</div>

    <input id="new_username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="new_password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button onclick="addClient()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    <p id="clientMsg"></p>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
<div id="transModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('transModal')">&times;</span>
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
    <input id="modal_amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
    <select id="modal_type">
        <option value="debit">Ø¹Ù„ÙŠÙ‡</option>
        <option value="credit">Ù„Ù‡</option>
    </select>
    <input id="modal_note" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù†">
    <div style="display:flex;gap:10px;margin-top:10px;">
        <button onclick="saveTransModal()">Ø­ÙØ¸</button>
        <button onclick="deleteTransModal()" style="background:#EF4444">Ø­Ø°Ù</button>
        <button onclick="closeModal('transModal')" style="background:#888">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<div id="clientsModal" class="modal">
  <div class="modal-body">
      <div style="display:flex;justify-content:space-between">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
        <button class="close-btn" onclick="closeModal('clientsModal')" style="background:#EF4444;padding:6px 12px">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <input id="search_client" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" oninput="filterClientsTable()" style="margin-top:10px">
      
      <table id="clientsBalanceTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                <th>ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="printClientsList()" style="background:#0b74de; color:white; margin-top:10px;">Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
<div id="clientsTotals" style="padding:10px;font-size:18px;font-weight:bold;color:#00693B"></div>

  </div>
  
</div>

<div id="numberPopup" style="
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    display: none;
    z-index: 9999;
    width: 250px;
    text-align: center;
">
    <h3 style="margin:0 0 10px;">Ø§Ø®ØªØ± Ø§Ù„Ø±Ù‚Ù…</h3>
    <div id="numbersList"></div>
    <button onclick="closePopup()" style="margin-top:10px;padding:6px 10px;">Ø¥Ù„ØºØ§Ø¡</button>
</div>


<script>
const API = "https://script.google.com/macros/s/AKfycbxYqTIZ2cmqd-9sRXNp27vli4MBpnCzgXJ4hxbEWMAg69ZRicb8pgjrGPGdkE7bPTLO/exec";
const waIcon = "https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg";

const qs = id => document.getElementById(id);
let allClients=[], clientTransactions=[], currentClientId="", currentTransId=null;

// Ù…ÙˆØ¯Ø§Ù„Ø§Øª
function openModal(id){ qs(id).style.display="flex"; }
function closeModal(id){ qs(id).style.display="none"; }
window.onclick = e=>{ if(e.target.classList.contains("modal")) e.target.style.display="none"; }

// ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
function logout(){ localStorage.clear(); window.location.href="index.html"; }

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
async function loadClients(){
    qs("loading").textContent="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...";
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"getClients"})});
    const data=await res.json();
    allClients=data;
    const select=qs("client_select"); select.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>`;
    data.forEach(c=>{
        const op=document.createElement("option");
        op.value=c.client_id; op.textContent=`${c.name} (${c.mobile})`;
        select.appendChild(op);
    });
    qs("loading").textContent="";
    updateStats();
}

// Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
function filterClientSelect(){
    const q=qs("client_search").value.toLowerCase();
    Array.from(qs("client_select").options).forEach(op=>{
        if(op.value==="") return;
        op.style.display=op.textContent.toLowerCase().includes(q)?"":"none";
    });
}

// Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
async function addClient(){
    const name=qs("new_name").value.trim();
    const mobile=qs("new_mobile").value.trim();
    const username=qs("new_username").value.trim();
    const password=qs("new_password").value.trim();
    const msg=qs("clientMsg");
    if(!name||!mobile||!username||!password){ msg.textContent="ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"; msg.style.color="red"; return; }
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"addClient",name,mobile,username,password})});
    const data=await res.json();
    if(data.status==="success"){ msg.textContent="ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­"; msg.style.color="green"; loadClients(); setTimeout(()=>closeModal("addClientModal"),800);}
    else{ msg.textContent="Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©"; msg.style.color="red"; }
}

// Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ©
async function addTrans(){
    const client_id=qs("client_select").value;
    let amount=Number(qs("amount").value);
    const type=qs("type").value; const note=qs("note").value;
    const msg=qs("msg"); if(!client_id||!amount||!note){ msg.textContent="ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"; msg.style.color="red"; return;}
    amount=type==="credit"?-Math.abs(amount):Math.abs(amount);
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"addTransaction",client_id,amount,type,note})});
    const data=await res.json();
    if(data.status==="success"){ msg.textContent="ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­"; msg.style.color="green"; qs("amount").value=""; qs("note").value=""; loadTransactions(); setTimeout(()=>msg.textContent="",2000);}
    else{ msg.textContent="Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©"; msg.style.color="red";}
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
async function loadTransactions(){
    currentClientId=qs("client_select").value; if(!currentClientId) return;
    qs("loading").textContent="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...";
    const res=await fetch(API,{method:"POST",body:JSON.stringify({action:"getClientData",client_id:currentClientId})});
    const data=await res.json();
    qs("loading").textContent=""; if(data.status!=="success") return;
    clientTransactions=data.list.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const total=data.total;
    const client=allClients.find(c=>c.client_id==currentClientId)||{};
    qs("total_info").textContent= total>=0?`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯: Ø¹Ù„ÙŠÙ‡ ${total} Ø±ÙŠØ§Ù„`:`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯: Ù„Ù‡ ${Math.abs(total)} Ø±ÙŠØ§Ù„`;
    updateStats();
    renderTransactions(clientTransactions.slice(0,3));
}

// Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
function showAllTransactions(){ renderTransactions(clientTransactions); }

// Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
function renderTransactions(transactions){
    const table = qs("transTable");
    table.innerHTML = "";

    // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯ÙˆÙ† ID ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
    const header = ["Ø§Ù„Ù…Ø¨Ù„Øº","Ø§Ù„Ù†ÙˆØ¹","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„ØªØ§Ø±ÙŠØ®","ÙˆØ§ØªØ³Ø§Ø¨"];
    const trH = document.createElement("tr");
    header.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trH.appendChild(th);
    });
    table.appendChild(trH);

    const client = allClients.find(c => c.client_id == currentClientId) || {};
    const clientName = client.name || "";
    const clientMobile = client.mobile || "";

    transactions.forEach(t => {
    const row = table.insertRow();
    row.onclick = () => openTransModal(t.trans_id);

    // Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ID ÙˆØ§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
    const cells = [
        Math.abs(t.amount),
        t.type === "debit" ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ù‡",
        t.note,
        new Date(t.date).toLocaleDateString()
    ];

    cells.forEach((c, i) => {
        const td = row.insertCell();
        td.textContent = c;
        if (i === 0) td.className = t.type === "debit" ? "debit" : "credit"; // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ø¨Ù„Øº
    });

    // Ø²Ø±ÙˆØ§ØªØ³Ø§Ø¨ ÙˆSMS
const waSmsCell = row.insertCell();
const groupDiv = document.createElement("div");
groupDiv.className = "wa-sms-group";

// Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨
const waBtn = document.createElement("button");
waBtn.className = "wa-btn";
waBtn.innerHTML = `<img src="${waIcon}"> ÙˆØ§ØªØ³Ø§Ø¨`;
waBtn.onclick = e => {
    e.stopPropagation();
    const total = clientTransactions.reduce((s, x) => s + Number(x.amount), 0);
    const typeText = t.type === "debit" ? "Ø¹Ù„ÙŠÙƒ" : "Ù„Ùƒ";
    const totalText = total >= 0 ? "Ø¹Ù„ÙŠÙƒ " + total : "Ù„Ùƒ " + Math.abs(total);
    const msg = `Ø§Ù„Ø§Ø®: ${clientName}\n${typeText} ${Math.abs(t.amount)} Ø±ÙŠØ§Ù„\nØµØ§ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ: ${totalText}`;
    const url = `https://wa.me/${clientMobile}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
};
groupDiv.appendChild(waBtn);

// Ø²Ø± SMS
const smsBtn = document.createElement("button");
smsBtn.className = "sms-btn";
smsBtn.textContent = "SMS";
smsBtn.onclick = e => {
    e.stopPropagation();
    const total = clientTransactions.reduce((s,x)=>s+Number(x.amount),0);
    const totalText = total >=0 ? "Ø¹Ù„ÙŠÙƒ " + total : "Ù„Ùƒ " + Math.abs(total);
    const typeText = t.type === "debit" ? "Ø¹Ù„ÙŠÙƒ" : "Ù„Ùƒ";
    const msg = `Ø§Ù„Ø§Ø®: ${clientName}\nÙ‚ÙŠØ¯ ${typeText} ${Math.abs(t.amount)} Ø±ÙŠØ§Ù„\nØµØ§ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ: ${totalText} Ø±ÙŠØ§Ù„/n#ÙŠÙ…Ù†_Ø³ØªÙ„Ø§ÙŠØª`;
    const url = `sms:${clientMobile}?body=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
};
groupDiv.appendChild(smsBtn);

waSmsCell.appendChild(groupDiv);

});

}


// ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
function openTransModal(id){ currentTransId=id; const t=clientTransactions.find(x=>x.trans_id==id); if(!t) return; qs("modal_amount").value=Math.abs(t.amount); qs("modal_type").value=t.type; qs("modal_note").value=t.note; openModal("transModal"); }
async function saveTransModal(){ if(!currentTransId) return; let amount=Number(qs("modal_amount").value); const type=qs("modal_type").value; const note=qs("modal_note").value; amount=type==="credit"?-Math.abs(amount):Math.abs(amount);
    await fetch(API,{method:"POST",body:JSON.stringify({action:"updateTransaction",trans_id:currentTransId,amount,type,note})}); closeModal("transModal"); loadTransactions(); }
async function deleteTransModal(){ if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return; await fetch(API,{method:"POST",body:JSON.stringify({action:"deleteTransaction",trans_id:currentTransId})}); closeModal("transModal"); loadTransactions(); }

// Ø·Ø¨Ø§Ø¹Ø© PDF Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨
function printTransactions() {
    if (!clientTransactions.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");

    const client = allClients.find(c => c.client_id == currentClientId) || {};
    const clientName = client.name || "";
    const total = clientTransactions.reduce((s, x) => s + Number(x.amount), 0);

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
    const companyName = "Ø´Ø±ÙƒØ© ÙŠÙ…Ù† Ø³ØªÙ„Ø§ÙŠØª";
    const companyPhone = "123456789"; // Ø¶Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
    const logoUrl = "https://raw.githubusercontent.com/falahsab/daftar/refs/heads/main/img/%D8%AF%D9%81%D8%AA%D8%B1-%D9%8A%D9%85%D9%86-%D8%B3%D8%AA%D9%84%D8%A7%D9%8A%D8%AA-192.png"; // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª

    const html = `
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>YemenSAT</title>
        <style>
            body { font-family: "Tajawal", sans-serif; direction: rtl; margin:20px; color:#0F172A; }
            header { display:flex; justify-content: space-between; align-items:center; border-bottom: 2px solid #00693B; padding-bottom:10px; margin-bottom:20px; }
            header img { height:60px; }
            header .client-info { text-align: center; flex:1; }
            header .client-info h2 { margin:0; color:#00693B; font-size:1.3em; }
            header .client-info p { margin:0; font-size:0.95em; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #444; padding: 10px; text-align: center; }
            th { background: #00A651; color: white; }
            tbody tr:nth-child(even) { background-color: #f2f2f2; }
            .debit { color: red; font-weight: bold; }
            .credit { color: green; font-weight: bold; }
            tfoot td { font-weight: bold; font-size: 1.05em; }
            footer { margin-top: 40px; text-align: left; font-weight: bold; font-size:0.9em; }
            @media print {
                body { margin: 0; }
                table { page-break-inside: auto; }
                tr { page-break-inside: avoid; page-break-after: auto; }
                thead { display: table-header-group; }
                tfoot { display: table-footer-group; }
                footer { position: fixed; bottom: 0; left: 20px; }
            }
        </style>
    </head>
    <body>
        <header>
            ${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : '<div style="width:60px;"></div>'}
            <div class="client-info">
                <h2>ØªÙ‚Ø±ÙŠØ± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
                <p>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${clientName}</p>
            </div>
            <div style="width:60px;"></div>
        </header>

        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
            </thead>
            <tbody>
                ${clientTransactions.map(t => {
                    const date = new Date(t.date);
                    const formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
                    return `
                        <tr>
                            <td class="${t.type === "debit" ? "debit" : "credit"}">${Math.abs(t.amount)}</td>
                            <td>${t.type === "debit" ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ù‡"}</td>
                            <td>${t.note}</td>
                            <td>${formattedDate}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" style="text-align: right;">ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</td>
                    <td style="color:${total >= 0 ? 'red' : 'green'};">
                        ${total >= 0 ? `Ø¹Ù„ÙŠÙ‡ ${total}` : `Ù„Ù‡ ${Math.abs(total)}`}
                    </td>
                </tr>
            </tfoot>
        </table>

        <footer>${companyName} | ${companyPhone}</footer>
    </body>
    </html>
    `;

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
    win.focus();
    setTimeout(() => win.print(), 500);
}


// Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨
async function showClientsBalances(){
    const res = await fetch(API, { method: "POST", body: JSON.stringify({ action: "getClientsBalance" }) });
    const data = await res.json(); 
    if(!Array.isArray(data)) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    data.sort((a,b) => b.total - a.total);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    let totalDebit = 0;   // Ø¹Ù„ÙŠÙ‡
    let totalCredit = 0;  // Ù„Ù‡

    data.forEach(c=>{
        if(c.total >= 0) totalDebit += c.total;
        else totalCredit += Math.abs(c.total);
    });

    const diff = totalDebit - totalCredit;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    const totalsDiv = document.getElementById("clientsTotals");
    if(totalsDiv){
        totalsDiv.innerHTML = `
            <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ùƒ:</strong> ${totalDebit} Ø±ÙŠØ§Ù„</div>
            <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù„ÙŠÙƒ:</strong> ${totalCredit} Ø±ÙŠØ§Ù„</div>
            <div><strong>Ø§Ù„ÙØ±Ù‚:</strong> 
                ${diff >= 0 ? `Ù„Ùƒ ${diff}` : `Ø¹Ù„ÙŠÙƒ ${Math.abs(diff)}`}
            </div>
        `;
    }

    const tbody = document.querySelector("#clientsBalanceTable tbody"); 
    tbody.innerHTML = "";

    data.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${c.client_id}</td>
            <td>${c.name}</td>
            <td>${c.mobile}</td>
            <td style="font-weight:bold;color:${c.total>=0?'red':'green'}">
                ${c.total>=0?`Ø¹Ù„ÙŠÙ‡ ${c.total}`:`Ù„Ù‡ ${Math.abs(c.total)}`}
            </td>
            <td>
                <button style="background:#EF4444;color:white;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;">
                    Ø­Ø°Ù
                </button>
            </td>
        `;
        tbody.appendChild(tr);

        tr.querySelector("button").addEventListener("click", async () => {
            if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${c.name}" ÙˆÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§ØªÙ‡ØŸ`)){
                const res = await fetch(API, {
                    method: "POST",
                    body: JSON.stringify({ action: "deleteClient", client_id: c.client_id })
                });
                const data = await res.json();
                if(data.status === "success"){
                    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­");
                    showClientsBalances();
                } else {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
                }
            }
        });
    });

    openModal("clientsModal");
}


function filterClientsTable(){
    const q=qs("search_client").value.toLowerCase();
    document.querySelectorAll("#clientsBalanceTable tbody tr").forEach(r=>{
        const name=r.children[1].textContent.toLowerCase();
        const mobile=r.children[2].textContent.toLowerCase();
        r.style.display=(name.includes(q)||mobile.includes(q))?"":"none";
    });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStats(){
    qs("stat_clients").textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${allClients.length}`;
    if(clientTransactions.length){ qs("stat_last").textContent="Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©: "+new Date(clientTransactions[0].date).toLocaleDateString(); }
    else{ qs("stat_last").textContent="Ù„Ø§ Ø¹Ù…Ù„ÙŠØ§Øª"; }
    const sum=clientTransactions.reduce((s,x)=>s+Number(x.amount),0);
    qs("stat_total").textContent=sum>=0?`ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨: Ø¹Ù„ÙŠÙ‡ ${sum}`:`ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨: Ù„Ù‡ ${Math.abs(sum)}`;
}

loadClients();
qs("client_select").addEventListener("change", loadTransactions);

  // Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØµØ§ÙÙŠ Ø­Ø³Ø§Ø¨Ø§ØªÙ‡Ù…
function printClientsList() {
    const rows = Array.from(document.querySelectorAll("#clientsBalanceTable tbody tr"))
                      .filter(r => r.style.display !== "none"); // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø®ÙÙŠØ©

    if (!rows.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");

    const companyName = "Ø´Ø±ÙƒØ© ÙŠÙ…Ù† Ø³ØªÙ„Ø§ÙŠØª";
    const companyPhone = "123456789";
    const logoUrl = ""; // Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©

    const html = `
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <style>
            body { font-family: "Tajawal", sans-serif; direction: rtl; margin:20px; color:#0F172A; }
            header { display:flex; justify-content: space-between; align-items:center; border-bottom: 2px solid #00693B; padding-bottom:10px; margin-bottom:20px; }
            header img { height:60px; }
            header .report-info { text-align: center; flex:1; }
            header .report-info h2 { margin:0; color:#00693B; font-size:1.3em; }
            header .report-info p { margin:0; font-size:0.95em; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #444; padding: 10px; text-align: center; }
            th { background: #00A651; color: white; }
            tbody tr:nth-child(even) { background-color: #f2f2f2; }
            tfoot td { font-weight: bold; font-size: 1.05em; }
            footer { margin-top: 40px; text-align: left; font-weight: bold; font-size:0.9em; }
            @media print {
                body { margin: 0; }
                table { page-break-inside: auto; }
                tr { page-break-inside: avoid; page-break-after: auto; }
                thead { display: table-header-group; }
                tfoot { display: table-footer-group; }
                footer { position: fixed; bottom: 0; left: 20px; }
            }
        </style>
    </head>
    <body>
        <header>
            ${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : '<div style="width:60px;"></div>'}
            <div class="report-info">
                <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${rows.length}</p>
            </div>
            <div style="width:60px;"></div>
        </header>

        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                    <th>ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                </tr>
            </thead>
            <tbody>
                ${rows.map(r => {
                    const name = r.children[1].textContent;
                    const mobile = r.children[2].textContent;
                    const totalText = r.children[3].textContent.trim(); // Ù…Ø«Ø§Ù„: "Ø¹Ù„ÙŠÙ‡ 500" Ø£Ùˆ "Ù„Ù‡ 200"
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ†
                    const color = totalText.startsWith("Ø¹Ù„ÙŠÙ‡") ? "red" : "green";

                    return `<tr>
                                <td>${name}</td>
                                <td>${mobile}</td>
                                <td style="color:${color}; font-weight:bold;">${totalText}</td>
                            </tr>`;
                }).join('')}
            </tbody>
        </table>

        <footer>${companyName} | ${companyPhone}</footer>
    </body>
    </html>
    `;

    const win = window.open("", "_blank");
    win.document.title = " "; // Ù„ØªØ¬Ù†Ø¨ about:blank
    win.document.write(html);
    win.document.close();
    win.focus();
    setTimeout(() => win.print(), 500);
}


//Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
function closePopup() {
    document.getElementById("numberPopup").style.display = "none";
}

document.getElementById("pickContact").addEventListener("click", async () => {
    if (!("contacts" in navigator && "select" in navigator.contacts)) {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„");
        return;
    }

    const contacts = await navigator.contacts.select(["tel"], { multiple: false });
    if (!contacts.length || !contacts[0].tel.length) return;

    let numbers = contacts[0].tel.map(n => {
        n = n.replace(/\s+/g, "")   // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
             .replace(/-/g, "")     // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø·Ø§Øª
             .replace(/\(/g, "")    // Ø¥Ø²Ø§Ù„Ø© (
             .replace(/\)/g, "");   // Ø¥Ø²Ø§Ù„Ø© )
        if (n.startsWith("+967")) n = n.slice(4);
        else if (n.startsWith("00967")) n = n.slice(5);
        else if (n.startsWith("967")) n = n.slice(3);
        n = n.replace(/^0/, "");    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙØ± Ø§Ù„Ø¨Ø§Ø¯Ø¦
        return n;
    });

    // Ø¥Ø°Ø§ Ø±Ù‚Ù… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
    if (numbers.length === 1) {
        document.getElementById("new_mobile").value = numbers[0];
        return;
    }

    // Ø¹Ø±Ø¶ popup Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
    const listDiv = document.getElementById("numbersList");
    listDiv.innerHTML = "";

    numbers.forEach(num => {
        let btn = document.createElement("button");
        btn.textContent = num;
        btn.style.cssText =
            "display:block;width:100%;margin:5px 0;padding:8px;border:none;background:#28a745;color:white;border-radius:6px;";
        btn.addEventListener("click", () => {
            document.getElementById("new_mobile").value = num; // Ù‡Ù†Ø§ ÙŠÙ„ØµÙ‚ Ø§Ù„Ø±Ù‚Ù…
            closePopup(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        });
        listDiv.appendChild(btn);
    });

    document.getElementById("numberPopup").style.display = "block";
});

//Ø­Ø°Ù Ø¹Ù…ÙŠÙ„ÙˆØ¹Ù…Ù„ÙŠØ§ØªÙ‡
async function deleteClient(client_id){
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§ØªÙ‡ØŸ")) return;

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
    const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify({action: "deleteClient", client_id})
    });
    const data = await res.json();

    if(data.status === "success"){
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­");
        loadClients(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    } else {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
    }
}

</script>

</body>
</html>
