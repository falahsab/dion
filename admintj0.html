<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة الإدارة | يمن ستلايت</title>

<style>
:root {
    --primary: #00693B; 
    --secondary: #00A651; 
    --bg: #F5F5F5;
    --card-bg: #FFFFFF;
    --text: #0F172A;
    --accent: #FFD700;
}

body { font-family: "Tajawal", sans-serif; background: var(--bg); margin:0; padding:20px; }

.card { max-width: 1000px; margin:auto; background: var(--card-bg); padding:25px; border-radius:15px; box-shadow:0 4px 12px #0002; }

h2,h3{ margin:12px 0; color: var(--primary); }

input, select, button { width: 100%; padding:12px; margin-top:10px; border:1px solid #d1d5db; border-radius:8px; font-size:1rem; box-sizing:border-box; }

button { background: var(--primary); color:white; border:none; cursor:pointer; transition:0.3s; }
button:hover { background: var(--secondary); }

.logout-btn { background:#EF4444; width:auto; padding:10px 20px; }
.logout-btn:hover { background:#DC2626; }

.table-container { overflow-x:auto; margin-top:20px; }

table { width:100%; border-collapse:collapse; font-size:0.95rem; }

th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:center; }

th { background: var(--secondary); color:white; }
.debit { color:red; font-weight:bold; }
.credit { color:green; font-weight:bold; }

.modal { display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); justify-content:center; align-items:center; }

.modal-content { background:#fff; margin:auto; padding:20px; border-radius:10px; width:90%; max-width:420px; animation:fadeIn 0.25s ease; }
@keyframes fadeIn { from{ opacity:0; transform:scale(.9); } to{ opacity:1; } }

.close { color:#555; font-size:28px; cursor:pointer; float:left; }
.close:hover{ color:#000; }

#clientsModal .modal-body { background:#fff; padding:18px; border-radius:10px; width:90%; max-width:900px; max-height:80vh; overflow:auto; }

.stat-box { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px #0001; text-align:center; flex:1; font-weight:bold; }

.wa-btn { background:#25D366;color:white;border:none;padding:6px 12px;border-radius:6px;display:flex;align-items:center;justify-content:center;gap:4px; }
.wa-btn img { width:16px; height:16px; vertical-align:middle; }

</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="admin"){ alert("يجب تسجيل الدخول كأدمن"); window.location.href="index.html"; }
</script>

<div class="card">

<h2>لوحة الإدارة | يمن ستلايت</h2>
<button class="logout-btn" onclick="logout()">تسجيل الخروج</button>

<div style="display:flex;gap:10px;margin:15px 0;">
    <div class="stat-box" id="stat_clients">جاري التحميل...</div>
    <div class="stat-box" id="stat_total">---</div>
    <div class="stat-box" id="stat_last">---</div>
</div>
<button type="button" onclick="openModal('addClientModal')">إضافة عميل جديد</button>
<h3>إضافة عملية مالية</h3>

<select id="client_select">
    <option value="">اختر العميل</option>
</select>


<input id="amount" type="number" placeholder="المبلغ">
<select id="type">
    <option value="debit">عليه</option>
    <option value="credit">له</option>
</select>
<input type="text" style="display:none" autocomplete="username">
<input type="password" style="display:none" autocomplete="new-password">

<input id="note" name="field987" placeholder="البيان"
       autocomplete="off"
       autofill="off"
       data-lpignore="true"
       autocapitalize="off"
       spellcheck="false">
<button id="addTransBtn" type="button" onclick="addTrans()">إضافة العملية</button>

<p id="msg"></p>
<p id="loading"></p>

<h3>آخر 3 عمليات للعميل</h3>
<p id="total_info"></p>

<button type="button" onclick="showAllTransactions()">عرض كل العمليات</button>
<button type="button" onclick="printTransactions()" style="background:#7a39ff;">طباعة PDF</button>

<div class="table-container">
    <table id="transTable"></table>
</div>

<button onclick="showClientsBalances()" style="background:#0b74de">عرض جميع العملاء وصافي حساباتهم</button>


</div>

<!-- مودال إضافة العميل -->
<div id="addClientModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('addClientModal')">&times;</span>
    <h3>إضافة عميل جديد</h3>
    <input id="new_name" placeholder="الاسم">
    <input id="new_mobile" type="number" placeholder="رقم الجوال">
    <input id="new_username" placeholder="اسم المستخدم">
    <input id="new_password" type="password" placeholder="كلمة المرور">
    <button onclick="addClient()">إضافة العميل</button>
    <p id="clientMsg"></p>
  </div>
</div>

<!-- مودال تعديل العملية -->
<div id="transModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('transModal')">&times;</span>
    <h3>تعديل العملية</h3>
    <input id="modal_amount" type="number" placeholder="المبلغ">
    <select id="modal_type">
        <option value="debit">عليه</option>
        <option value="credit">له</option>
    </select>
    <input id="modal_note" placeholder="البيان">
    <div style="display:flex;gap:10px;margin-top:10px;">
        <button onclick="saveTransModal()">حفظ</button>
        <button onclick="deleteTransModal()" style="background:#EF4444">حذف</button>
        <button onclick="closeModal('transModal')" style="background:#888">إلغاء</button>
    </div>
  </div>
</div>

<!-- مودال العملاء -->
<div id="clientsModal" class="modal">
  <div class="modal-body">
      <div style="display:flex;justify-content:space-between">
        <h3>قائمة العملاء وصافي الحساب</h3>
        <button class="close-btn" onclick="closeModal('clientsModal')" style="background:#EF4444;padding:6px 12px">إغلاق</button>
      </div>
      <input id="search_client" placeholder="ابحث بالاسم أو رقم الجوال" oninput="filterClientsTable()" style="margin-top:10px">
      <table id="clientsBalanceTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>العميل</th>
                <th>الجوال</th>
                <th>صافي الحساب</th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="printClientsList()" style="background:#0b74de; color:white; margin-top:10px;">طباعة قائمة العملاء</button>

  </div>
  
</div>

<script>
// ===================== حماية API =====================
const API = "https://script.google.com/macros/s/AKfycbzV7lwgDjZ3kz60kCL0YbLCkQoRm6sMtUkzePtAjZuzmC279z3mtHUEEPpwLc4BTzyd/exec"; // ضع رابط الـ Proxy الجديد هنا
const SECRET = "FALAH2025";       // مفتاح سري
const ALLOWED_ORIGIN = "https://falahsab.github.io"; // رابط موقعك

// ===================== الدوال الأصلية =====================
function logout() { localStorage.clear(); window.location.href="index.html"; }

function showAddClientModal(){ document.getElementById("addClientModal").style.display="block"; }
function closeAddClientModal(){ document.getElementById("addClientModal").style.display="none"; }
function closeTransModal(){ document.getElementById("transModal").style.display="none"; currentTransId=null; }

let allClients = [];

async function loadClients(){
    document.getElementById("loading").textContent = "جاري تحميل العملاء...";
    const res = await fetch(API, {
        method:"POST",
        body: JSON.stringify({
            action:"getClients",
            secret: SECRET,
            origin: window.location.origin,
            token: generateToken()
        })
    });
    const data = await res.json();
    allClients = data;
    const select = document.getElementById("client_select");
    select.innerHTML = `<option value="">اختر العميل</option>`;
    data.forEach(c=>{
        let opt = document.createElement("option");
        opt.value = c.client_id;
        opt.textContent = `${c.name} (${c.mobile})`;
        select.appendChild(opt);
    });
    document.getElementById("loading").textContent = "";
}

async function addClient(){
    const name = document.getElementById("new_name").value.trim();
    const mobile = document.getElementById("new_mobile").value.trim();
    const username = document.getElementById("new_username").value.trim();
    const password = document.getElementById("new_password").value.trim();
    const msg = document.getElementById("clientMsg");
    if(!name || !mobile || !username || !password){ 
        msg.textContent="يرجى تعبئة كل الحقول"; 
        msg.style.color="red"; 
        return; 
    }
    const res = await fetch(API, {
        method:"POST",
        body: JSON.stringify({
            action:"addClient",
            name, mobile, username, password,
            secret: SECRET,
            origin: window.location.origin,
            token: generateToken()
        })
    });
    const data = await res.json();

    if(data.status==="success"){ 
        msg.textContent="تمت الإضافة بنجاح"; 
        msg.style.color="green"; 
        closeAddClientModal(); 
        loadClients();
        setTimeout(() => { msg.textContent = ""; }, 3000);
    } else { 
        msg.textContent="حدث خطأ أثناء الإضافة"; 
        msg.style.color="red"; 
    }
}

async function addTrans(){
    const client_id = document.getElementById("client_select").value;
    let amount = Number(document.getElementById("amount").value);
    const type = document.getElementById("type").value;
    const note = document.getElementById("note").value;
    const msg = document.getElementById("msg");
    if(!client_id || !amount || !note){ 
        msg.textContent="يرجى تعبئة كل الحقول"; 
        msg.style.color="red"; 
        return; 
    }
    amount = type==="credit" ? -Math.abs(amount) : Math.abs(amount);
    const res = await fetch(API,{
        method:"POST",
        body: JSON.stringify({
            action:"addTransaction",
            client_id, amount, type, note,
            secret: SECRET,
            origin: window.location.origin,
            token: generateToken()
        })
    });
    const data = await res.json();

    if(data.status==="success"){ 
        msg.textContent = "تمت الإضافة بنجاح"; 
        msg.style.color = "green"; 
        document.getElementById("amount").value=""; 
        document.getElementById("note").value=""; 
        loadTransactions();
        setTimeout(() => { msg.textContent = ""; }, 3000);
    } else { 
        msg.textContent="حدث خطأ أثناء الإضافة"; 
        msg.style.color="red"; 
    }
}

let currentClientId=""; let clientTransactions=[]; let currentTransId=null;

async function loadTransactions(){
    currentClientId=document.getElementById("client_select").value;
    if(!currentClientId) return;
    document.getElementById("loading").textContent = "جاري تحميل العمليات...";
    const res = await fetch(API,{
        method:"POST",
        body: JSON.stringify({
            action:"getClientData",
            client_id: currentClientId,
            secret: SECRET,
            origin: window.location.origin,
            token: generateToken()
        })
    });
    const data = await res.json();
    document.getElementById("loading").textContent = "";
    if(data.status!=="success") return;
    clientTransactions = data.list.sort((a,b)=>new Date(b.date)-new Date(a.date));
    const total = data.total;
    document.getElementById("total_info").textContent = `إجمالي الرصيد: ${total>=0?"عليه "+total:"له "+Math.abs(total)} ريال`;
    renderTransactions(clientTransactions.slice(0,3));
}

function showAllTransactions(){ renderTransactions(clientTransactions); }

function openTransModal(trans_id){
    currentTransId=trans_id;
    const t=clientTransactions.find(tr=>tr.trans_id==trans_id);
    if(!t) return;
    document.getElementById("modal_amount").value=Math.abs(t.amount);
    document.getElementById("modal_type").value=t.type;
    document.getElementById("modal_note").value=t.note;
    document.getElementById("transModal").style.display="block";
}

async function saveTransModal(){
    if(!currentTransId) return;
    let amount=Number(document.getElementById("modal_amount").value);
    const type=document.getElementById("modal_type").value;
    const note=document.getElementById("modal_note").value;
    if(!amount||!note){ alert("يرجى تعبئة كل الحقول"); return; }
    amount = type==="credit" ? -Math.abs(amount) : Math.abs(amount);
    const res=await fetch(API,{ 
        method:"POST",
        body: JSON.stringify({
            action:"updateTransaction",
            trans_id:currentTransId,
            amount, type, note,
            secret: SECRET,
            origin: window.location.origin,
            token: generateToken()
        })
    });
    const data=await res.json();
    if(data.success||data.status==="success"){ alert("تم الحفظ بنجاح"); closeTransModal(); loadTransactions(); }
    else alert("حدث خطأ أثناء الحفظ");
}

async function deleteTransModal(){
    if(!currentTransId) return;
    if(!confirm("هل أنت متأكد من حذف العملية؟")) return;
    const res=await fetch(API,{ 
        method:"POST",
        body: JSON.stringify({
            action:"deleteTransaction",
            trans_id:currentTransId,
            secret: SECRET,
            origin: window.location.origin,
            token: generateToken()
        })
    });
    const data=await res.json();
    if(data.success||data.status==="success"){ alert("تم الحذف بنجاح"); closeTransModal(); loadTransactions(); }
    else alert("حدث خطأ أثناء الحذف");
}

function renderTransactions(transactions){
    const table = document.getElementById("transTable");
    table.innerHTML = '';
    const header = ["ID","العميل","المبلغ","النوع","البيان","التاريخ","واتساب"];
    const trHeader = document.createElement("tr");
    header.forEach(h => { const th = document.createElement("th"); th.textContent = h; trHeader.appendChild(th); });
    table.appendChild(trHeader);

    const clientName = allClients.find(c => c.client_id == currentClientId)?.name || "غير معروف";
    const clientMobile = allClients.find(c => c.client_id == currentClientId)?.mobile || "";

    transactions.forEach(t => {
        const row = table.insertRow();
        row.onclick = () => openTransModal(t.trans_id);

        const cells = [
            t.trans_id,
            clientName,
            Math.abs(t.amount),
            t.type==='debit'?'عليه':'له',
            t.note,
            new Date(t.date).toLocaleDateString()
        ];

        cells.forEach((c,i) => {
            const cell = row.insertCell();
            cell.textContent = c;
            if(i===2){ cell.className = t.type==='debit'?'debit':'credit'; }
        });

        const waCell = row.insertCell();
        const waBtn = document.createElement("button");
        waBtn.textContent = "واتساب";
        waBtn.style.background="#25D366";
        waBtn.style.color="#fff";
        waBtn.style.border="none";
        waBtn.style.padding="6px 12px";
        waBtn.style.borderRadius="6px";
        waBtn.style.cursor="pointer";

        waBtn.onclick = (e) => {
            e.stopPropagation();
            const total = clientTransactions.reduce((sum,tr) => sum + Number(tr.amount), 0);
            const typeText = t.type==='debit' ? 'عليكم' : 'لكم';
            const totalText = total >= 0 ? `عليكم ${total}` : `لكم ${Math.abs(total)}`;
            const msg = `\u{1F464} الاخ: ${clientName}
\u{1F4B0} قيد ${typeText} مبلغ: ${Math.abs(t.amount)} ريال
\u{1F4DD} البيان: ${t.note}
---------------
\u{1F4CA} صافي حسابك:
    ${totalText} ريال

\u{2B50} #يمن-ستلايت`;

            const url = `https://wa.me/${clientMobile}?text=${encodeURIComponent(msg)}`;
            window.open(url, "_blank");
        };

        waCell.appendChild(waBtn);
    });
}

// ===================== Token توليد تلقائي =====================
function generateToken(){
    return btoa(Date.now().toString()).slice(-8);
}

// ===================== تحميل أولي =====================
loadClients();
document.getElementById("client_select").addEventListener("change",loadTransactions);

// ===================== إغلاق النوافذ عند الضغط خارجها =====================
window.onclick = function(event){
    const addModal = document.getElementById("addClientModal");
    const transModal = document.getElementById("transModal");
    if(event.target===addModal) addModal.style.display="none";
    if(event.target===transModal) transModal.style.display="none";
};

// ===================== صافي أرصدة العملاء =====================
async function showClientsBalances() {
    document.getElementById("loading").textContent = "جاري تحميل أرصدة العملاء...";
    try {
        const res = await fetch(API, {
            method: "POST",
            body: JSON.stringify({
                action: "getClientsBalance",
                secret: SECRET,
                origin: window.location.origin,
                token: generateToken()
            })
        });
        const data = await res.json();
        document.getElementById("loading").textContent = "";

        if (!Array.isArray(data)) { alert("حدث خطأ أثناء جلب البيانات"); return; }

        const tbody = document.querySelector("#clientsBalanceTable tbody");
        tbody.innerHTML = "";
        data.forEach(c => {
            const tr = document.createElement("tr");
            const idTd = document.createElement("td"); idTd.textContent = c.client_id;
            const nameTd = document.createElement("td"); nameTd.textContent = c.name;
            const mobileTd = document.createElement("td"); mobileTd.textContent = c.mobile;
            const totalTd = document.createElement("td");
            const totalVal = Number(c.total);
            totalTd.textContent = totalVal >= 0 ? `عليه ${totalVal}` : `له ${Math.abs(totalVal)}`;
            totalTd.style.fontWeight = "bold";
            totalTd.style.color = totalVal >= 0 ? "red" : "green";

            tr.appendChild(idTd); tr.appendChild(nameTd); tr.appendChild(mobileTd); tr.appendChild(totalTd);
            tbody.appendChild(tr);
        });

        openClientsModal();
    } catch (err) {
        document.getElementById("loading").textContent = "";
        alert("فشل جلب أرصدة العملاء");
        console.error(err);
    }
}

function openClientsModal() { const m = document.getElementById("clientsModal"); m.style.display = "flex"; m.style.alignItems = "center"; }
function closeClientsModal() { document.getElementById("clientsModal").style.display = "none"; }

function filterClientsTable() {
    const q = document.getElementById("search_client").value.trim().toLowerCase();
    const rows = document.querySelectorAll("#clientsBalanceTable tbody tr");
    rows.forEach(r => {
        const name = r.children[1].textContent.toLowerCase();
        const mobile = r.children[2].textContent.toLowerCase();
        r.style.display = (name.includes(q) || mobile.includes(q) || q==="") ? "" : "none";
    });
}

</script>

</body>
</html>
